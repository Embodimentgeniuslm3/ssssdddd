import {Note} from "src/components/note";


<Column>
  <Browser
    style={{height: "100%"}}
    height={300}
    loadUrl="https://d3uiem601ewx5l.cloudfront.net/"
    id="final"
    zoom={0.5}
  />
</Column>

# Getting Started with Next.js

The open-source Amplify Framework provides the following products to build fullstack iOS, Android, Flutter, Web, and React Native apps:

- **Amplify [CLI](~/cli/cli.md)** - Configure all the services needed to power your backend through a simple command line interface.
- **Amplify [Libraries](~/lib/lib.md)** - Use case-centric client libraries to integrate your app code with a backend using declarative interfaces.
- **Amplify [UI Components](~/ui/ui.md)** - UI libraries for React, React Native, Angular, Ionic and Vue.

The **Amplify [Console](https://aws.amazon.com/amplify/console/)** is an AWS service that provides a git-based workflow for continuous deployment & hosting of fullstack web apps. Cloud resources created by the Amplify CLI are also visible in the Amplify Console.

## What we'll build

This tutorial guides you through setting up a backend and integrating that backend with a new [Next.js](https://nextjs.org/) app.

You will create a simple blog with a GraphQL API and to store and retrieve items in a cloud database. In addition, weâ€™ll demonstrate how to authenticate users, communicate with our API, and deploy to AWS.

[GraphQL](http://graphql.org) is a data language that was developed to enable apps to fetch data from APIs. It has a declarative, self-documenting style. In a GraphQL operation, the client specifies how to structure the data when it is returned by the server. This makes it possible for the client to query only for the data it needs, in the format that it needs it in.

<br />
<docs-internal-link-button href="~/start/getting-started/installation.md">
  <span slot="text">Start the Tutorial ðŸš€</span>
</docs-internal-link-button>

**NEW!** Use the Admin UI to get started with Amplify. [Get started](https://sandbox.amplifyapp.com/start#datastore)

## Prerequisites {#prerequisites}

Before we begin, make sure you have the following installed:

- [Node.js](https://nodejs.org/) v10.x or later
- [npm](https://www.npmjs.com/) v5.x or later
- [git](https://git-scm.com/) v2.14.1 or later

<inline-fragment integration="react" src="~/start/getting-started/fragments/react/prereq.md"></inline-fragment> <inline-fragment integration="react-native" src="~/start/getting-started/fragments/reactnative/prereq.md"></inline-fragment>

### Sign up for an AWS account

If you don't already have an AWS account, you'll need to create one in order to follow the steps outlined in this tutorial.

[Create AWS Account](https://portal.aws.amazon.com/billing/signup?redirect_url=https%3A%2F%2Faws.amazon.com%2Fregistration-confirmation#/start)

> There are no upfront charges or any term commitments to create an AWS account and signing up gives you immediate access to the AWS Free Tier.

<Column>
  <Browser
    style={{height: "100%"}}
    height={300}
    loadUrl="https://www.youtube-nocookie.com/embed/fWbM5DLh25U"
    id="video-guide"
  />
</Column>

### Install and configure the Amplify CLI

The Amplify Command Line Interface (CLI) is a unified toolchain to create AWS cloud services for your app. Let's go ahead and install the Amplify CLI.

#### Option 1: Watch the video guide

Watch the video below to learn how to install and configure the Amplify CLI or skip to the next section to follow the step-by-step instructions.

<Column>
  <Terminal id="amplify-configure" text="$ npm install -g @aws-amplify/cli" />
</Column>

#### Option 2: Follow the instructions

> Because we're installing the Amplify CLI globally, you might need to run the command above with `sudo`.

<Column>
  <Terminal id="amplify-configure" text="$ amplify configure" />
</Column>

Now it's time to setup the Amplify CLI. Configure Amplify by running the following command:

`amplify configure` will ask you to sign into the AWS Console.

<Column>
  <Terminal
    id="amplify-configure"
    text={`$ amplify configure
\n
Specify the AWS Region
? region:  # Your preferred region
Specify the username of the new IAM user:
? user name:  # User name for Amplify IAM user
Complete the user creation using the AWS console
`}
  />
</Column>

Once you're signed in, Amplify CLI will ask you to create an IAM user.

> Amazon IAM (Identity and Access Management) enables you to manage users and user permissions in AWS. You can learn more about Amazon IAM [here](https://aws.amazon.com/iam/).

<Column>
  <Browser
    style={{height: "100%"}}
    height={300}
    loadUrl="/images/user-creation.gif"
    id="final"
    zoom={1.2}
  />
</Column>

Create a user with `AdministratorAccess` to your account to provision AWS resources for you like AppSync, Cognito etc.

<Column>
  <Terminal
    id="amplify-configure"
    text={`
$ amplify configure
\n
Enter the access key of the newly created user:
? accessKeyId:  # YOUR_ACCESS_KEY_ID
? secretAccessKey:  # YOUR_SECRET_ACCESS_KEY
This would update/create the AWS Profile in your local machine
? Profile Name:  # (default)
\n
Successfully set up the new user.
`}
  />
</Column>

Once the user is created, Amplify CLI will ask you to provide the `accessKeyId` and the `secretAccessKey` to connect Amplify CLI with your newly created IAM user.

Next, we'll set up the app and initialize Amplify!

## Set up fullstack project


<Column>
  {/* <Terminal id="amplify-mock" text="$ npx create-next-app next-amplified" /> */}
  <Cast src="/npx.cast" />
</Column>




### Create a new Next.js App

To set up the project, we'll first create a new Next.js app with [Create Next App](https://nextjs.org/docs/api-reference/create-next-app), a simple CLI tool that enables you to quickly start building a new Next.js application, with everything set up for you. We'll then add Amplify and initialize a new project.

From your projects directory, run the following commands:

```bash
npx create-next-app next-amplified
cd next-amplified
```

This creates a new Next.js app in a directory called `next-amplified` and then switches us into that new directory.

Now that we're in the root of the project, we can run the app by using the following command:

```bash
npm run dev
```

This runs a development server and allows us to see the output generated by the build, you can see the running app by navigating to <http://localhost:3000>.

<Column>
  <Terminal id="amplify-init" text="$ amplify init" />
</Column>

### Initialize a new backend

Now that we have a running Next.js app, it's time to set up Amplify so that we can create the necessary backend services needed to support the app.

<Column>
  <Terminal
    id="amplify-init"
    text={`$ amplify init
\n
Enter a name for the project (nextamplified)
\n
# All AWS services you provision for your app are grouped into an "environment"
# A common naming convention is dev, staging, and production
Enter a name for the environment (dev)
\n
# Sometimes the CLI will prompt you to edit a file, it will use this editor to open those files.
Choose your default editor
\n
# Amplify supports JavaScript (Web & React Native), iOS, and Android apps
Choose the type of app that you're building (javascript)
\n
What JavaScript framework are you using (react)
\n
Source directory path (src)
\n
Distribution directory path (build)
\n
Build command (npm run build)
\n
Start command (npm start)
\n
# This is the profile you created with the \`amplify configure\` command in the introduction step.
Do you want to use an AWS profile?
`}
  />
</Column>

When you initialize Amplify you'll be prompted for some information about the app:

> Where possible the CLI will infer the proper configuration based on the type of project Amplify is being initialized in. In this case it knew we are using Create Next App and provided the proper configuration for type of app, framework, source, distribution, build, and start options.

When you initialize a new Amplify project, a few things happen:

- It creates a top level directory called `amplify` that stores your backend definition. During the tutorial you'll add capabilities such as a GraphQL API and authentication. As you add features, the `amplify` folder will grow with infrastructure-as-code templates that define your backend stack. Infrastructure-as-code is a best practice way to create a replicable backend stack.
- It creates a file called `aws-exports.js` in the `src` directory that holds all the configuration for the services you create with Amplify. This is how the Amplify client is able to get the necessary information about your backend services.
- It modifies the `.gitignore` file, adding some generated files to the ignore list
- A cloud project is created for you in the AWS Amplify Console that can be accessed by running `amplify console`. The Console provides a list of backend environments, deep links to provisioned resources per Amplify category, status of recent deployments, and instructions on how to promote, clone, pull, and delete backend resources

As you add or remove categories and make updates to your backend configuration using the Amplify CLI, the configuration in **aws-exports.js** will update automatically.

<Column>
  <Terminal
    id="npm-install"
    text="$ npm install aws-amplify @aws-amplify/ui-react"
  />
</Column>

### Install Amplify libraries

The first step to using Amplify in the client is to install the necessary dependencies:

The `aws-amplify` package is the main library for working with Amplify in your apps. The `@aws-amplify/ui-react` package includes React-specific UI components we'll use as we build the app.

Now that our Next.js app is set up and Amplify is initialized, we're ready to add an API in the next step.

## Connect API and database to the app

Now that youâ€™ve created and configured a Next.js app and initialized a new Amplify project, you can add a feature. The first feature you will add is an API.

The Amplify CLI supports creating and interacting with two types of API categories: REST and GraphQL.

The API you will be creating in this step is a GraphQL API using AWS AppSync (a managed GraphQL service) and the database will be Amazon DynamoDB (a NoSQL database).

<Column>
  <Terminal id="amplify-add-api" text="$ amplify add api" />
</Column>

### Create a GraphQL API and database

Add a [GraphQL API](https://docs.aws.amazon.com/appsync/latest/devguide/designing-a-graphql-api.html) to your app and automatically provision a database by running the following command from the root of your application directory:

<Column>
  <Terminal
    id="amplify-add-api"
    text={
      "$ amplify add api\n" +
      require("!!raw-loader!./amplify-add-api.txt").default
    }
  />
</Column>

Select the explicit values below to enable **IAM** (for public read access) and **Cognito User Pools** (for authenticated access).

<Column>
  <Editor
    code={require("!!raw-loader!./schema.graphql").default}
    file="amplify/backend/api/myapi/schema.graphql"
    lang="jsx"
    height={270}
    id="schema.graphql"
  />
</Column>

The CLI will then open this GraphQL schema in your text editor.

The schema generated is for a blog app. You'll notice a directive on the `Post` type of `@model`. This directive is part of the [GraphQL transform](~/cli/graphql-transformer/model.md) library of Amplify.

The GraphQL Transform Library provides custom directives you can use in your schema that allow you to do things like define data models, set up authentication and authorization rules, configure serverless functions as resolvers, and more.

A type decorated with the `@model` directive will scaffold out the database table for the type (Post table), the schema for CRUD (create, read, update, delete) and list operations, and the GraphQL resolvers needed to make everything work together.

From the command line, press **enter** to accept the schema and continue to the next steps.

<Column>
  <Terminal id="amplify-push" text="$ amplify push" />
</Column>

### Deploying the API

To deploy this backend, run the `push` command:

<Column>
  <Terminal
    id="amplify-push"
    text={`$ amplify push
Current Environment: dev
\n
| Category | Resource name         | Operation | Provider plugin   |
| -------- | --------------------- | --------- | ----------------- |
| Auth     | nextamplifiedXXXXXXX  | Create    | awscloudformation |
| Api      | nextamplified         | Create    | awscloudformation |
? Are you sure you want to continue? Y
\n
# You will be walked through the following questions for GraphQL code generation
? Do you want to generate code for your newly created GraphQL API? Y
? Choose the code generation language target: javascript
? Enter the file name pattern of graphql queries, mutations and subscriptions: src/graphql/**/*.js
? Do you want to generate/update all possible GraphQL operations - queries, mutations and subscriptions? Y
? Enter maximum statement depth [increase from default if your schema is deeply nested]: 2
`}
  />
</Column>

Now the API is live and you can start interacting with it!

The API you have deployed includes operations for creating, reading, updating, deleting, and listing posts.

<Column>
  <Terminal id="amplify-status" text="$ amplify status" />
</Column>

Next, run the following command to check Amplify's status:

<Column>
  <Terminal
    id="amplify-status"
    text={`$ amplify status
\n
Current Environment: dev
\n
| Category | Resource name         | Operation | Provider plugin   |
| -------- | --------------------- | --------- | ----------------- |
| Auth     | nextamplifiedXXXXXXXX | No Change | awscloudformation |
| Api      | nextamplified         | No Change | awscloudformation |
`}
  />
</Column>

This will give us the current status of the Amplify project, including the current environment, any categories that have been created, and what state those categories are in. It should look similar to this:

<Column>
  <Terminal id="amplify-console" text="$ amplify console api" />
</Column>

To view the GraphQL API in the AppSync console at any time, run the following command:

<Column>
  <Terminal id="amplify-console" text="$ amplify console" />
</Column>

To view your entire app in the Amplify console at any time, run the following command:

<Column>
  <Terminal id="amplify-mock" text="$ amplify mock api" />
</Column>

### (Optional) Test your API

To test this out locally, you can run the `mock` command.

<Column>
  <Terminal
    id="amplify-mock"
    text={`$ amplify mock api
\n
# If you have not already deployed you API, you will be walked through the following steps for GraphQL code generation
? Choose the code generation language target: javascript (or preferred target)
? Enter the file name pattern of graphql queries, mutations and subscriptions: src/graphql/**/*.js
? Do you want to generate/update all possible GraphQL operations - queries, mutations and subscriptions: Yes
? Enter maximum statement depth [increase from default if your schema is deeply nested] 2
`}
  />
</Column>

> If you'd like to go ahead and connect the front end, you can [jump to the next step](#connect-frontend-to-api).

_Note:_ `amplify mock api` requires Java.

This will open the GraphiQL explorer on a local port. From the test environment you can try out different operations locally, like queries and mutations.

<Column>
  <Editor
    code={`
mutation CreatePost {
  createPost(input: {title: "Test Post", content: "post content"}) {
    id
    owner
    title
    updatedAt
    createdAt
    content
  }
}
`}
    file="GraphiQL"
    lang="jsx"
    height={270}
    id="GraphiQL"
  />
</Column>

In the GraphiQL toolbar, select **Use: User Pool** and try creating a post:

<Column>
  <Editor
    code={`
query ListPosts {
  listPosts {
    items {
      content
      createdAt
      id
      owner
      title
    }
  }
}
`}
    file="GraphiQL"
    lang="jsx"
    height={270}
    id="GraphiQL"
  />
</Column>

Next, update auth to **Use: API Key** and try querying the list of posts:

<Column>
  <Editor
    code=""
    file="pages/index.js"
    lang="jsx"
    height={500}
    id="pages/index.js"
  />
</Column>

### API with Server-Side Rendering (SSR)

In this section you will create a way to list and create posts from the Next.js application. To do this, you will fetch & render the latest posts from the server as well as create a new post on the client.

<Column>
  <Editor
    code={require("!!raw-loader!./pages/index-01.js").default}
    file="pages/index.js"
    lang="jsx"
    height={500}
    id="pages/index.js"
  />
</Column>

Open **pages/index.js** and replace it with the following code:

Let's walk through some of this file:

- **Amplify.configure** â€“ For authenticated requests to work on the server, our client has to be configured with `ssr: true` to make credentials available on subsequent requests.

<Column>
  <Editor
    code={require("!!raw-loader!./pages/index-02.js").default}
    file="pages/index.js"
    lang="jsx"
    height={500}
    id="pages/index.js"
  />
</Column>

- **getServerSideProps** â€“ For each request (`req`) on the server, we create a copy of Amplify (called `SSR` here from `withSSRContext({ req })`) that scopes credentials, data, and storage to _just one_ request. `API.graphql` queries for a list of posts, and returns them as the `posts` prop for the `Home` component.

<Column>
  <Editor
    code={require("!!raw-loader!./pages/index-03.js").default}
    file="pages/index.js"
    lang="jsx"
    height={500}
    id="pages/index.js"
  />
</Column>

- **handleCreatePost** â€“ This function is called when a logged-in user submits our "New Post" form. `API.graphql` is called to create the new post's `title` and `content`. Once created, we redirect to `/posts/${post.id}`. Notice that we explicitly set `authMode` to `AMAZON_COGNITO_USER_POOLS`. This is because our `schema.graphql` explicitly requires an authorized user to create/delete/update our **Post** model. Based on our configuration when we ran `amplify add api`, this value is defaulting to `API_KEY`.

<Column>
  <Editor
    code={require("!!raw-loader!./pages/index.js").default}
    file="pages/index.js"
    lang="jsx"
    height={500}
    id="pages/index.js"
  />
</Column>

- **Home** â€“ This is a _functional component_ that renders the `posts` provided by `getServerSideProps`.

<Column>
  <Terminal id="npm-run-dev" text="$ npm run dev" />
</Column>

### Testing SSR

Next, run the app and you should see a landing page with `0 posts` with a login screen:

Once you create an account and login, you will be presented with the **New Post** form.

Submit that form to create a new post, and we'll build that page next!

<Column>
  <Editor
    code={""}
    file="pages/posts/[id].js"
    lang="jsx"
    height={500}
    id="pages/posts/[id].js"
  />
</Column>

### API with Incremental Static Site Generation (SSG)

Statically generating pages during the build process improves performance. But, dynamically created posts still need to not `404`.

To solve this, create **pages/posts/[id].js** and paste in the following content:

Let's walk through some of this file:

<Column>
  <Editor
    code={require("!!raw-loader!./pages/posts/[id]-01.js").default}
    file="pages/posts/[id].js"
    lang="jsx"
    height={500}
    id="pages/posts/[id].js"
  />
</Column>

- **Amplify.configure** â€“ For authenticated requests to work on the server, our client has to be configured with `ssr: true` to make credentials available on subsequent requests.

<Column>
  <Editor
    code={require("!!raw-loader!./pages/posts/[id]-02.js").default}
    file="pages/posts/[id].js"
    lang="jsx"
    height={500}
    id="pages/posts/[id].js"
  />
</Column>

- **getStaticPaths** â€“ Because the value of `[id]` isn't known at build-time, we need to provide all possible `paths` for Next.js to render pages for. We do this by querying all posts with `API.graphql`, and mapping each `post` into `{ params: { id: post.id }}`. These `params` are passed to `getStaticProps` next. Note that we return `fallback: true`. If this value were `false`, then any _new_ posts would return a `404` because they didn't exist at build-time. With `true`, static pages are returned quickly, while any new `id`s are looked up once.

<Column>
  <Editor
    code={require("!!raw-loader!./pages/posts/[id]-03.js").default}
    file="pages/posts/[id].js"
    lang="jsx"
    height={500}
    id="pages/posts/[id].js"
  />
</Column>

- **getStaticProps** â€“ Because the `Post` components props aren't dynamic per-request, they're provided statically from `getStaticPaths` as `params`. Here, we use `params.id` to query for that specific post with `API.graphql`.

<Column>
  <Editor
    code={require("!!raw-loader!./pages/posts/[id]-04.js").default}
    file="pages/posts/[id].js"
    lang="jsx"
    height={500}
    id="pages/posts/[id].js"
  />
</Column>

- **Post** â€“ `Post` is a functional component that renders the provided prop `post`. Because `fallback: true` was specified above, we have to account for a "loading" state while a new post may be fetched.

<Column>
  <Editor
    code={require("!!raw-loader!./pages/posts/[id].js").default}
    file="pages/posts/[id].js"
    lang="jsx"
    height={500}
    id="pages/posts/[id].js"
  />
</Column>

- **handleDelete** â€“Â This function is called when the "Delete post" button is clicked. Notice that we explicitly set `authMode` to `AMAZON_COGNITO_USER_POOLS`. This is because our `schema.graphql` explicitly requires an authorized user to create/delete/update our **Post** model. Based on our configuration when we ran `amplify add api`, this value is defaulting to `API_KEY`.

For each request (`req`) on the server, we create a copy of Amplify (called `SSR` here from `withSSRContext({ req })`) that scopes credentials, data, and storage to _just one_ request. `API.graphql` queries for a list of posts, and returns them as the `posts` prop for the `Home` component.

- **Home** â€“ This is a _functional component_ that renders the `posts` provided by `getServerSideProps`.

<Column>
  <Browser
    style={{height: "100%"}}
    height={500}
    loadUrl="https://d3uiem601ewx5l.cloudfront.net/"
    id="final"
    zoom={0.5}
  />
</Column>

### Testing SSG

With your server running (`npm run dev`), refresh the page (or go back home to <http://localhost:3000/> and click into a post) and you'll see a page for this post!

<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
